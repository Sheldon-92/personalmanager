# ADR-0004: Python版本口径

## 状态
已接受

## 背景

PersonalManager作为Python CLI工具，需要确定支持的Python版本范围。这个决策影响到用户的安装门槛、开发复杂度、功能特性使用、依赖库兼容性等多个关键方面。

在制定Python版本策略时，需要考虑以下因素：

### 用户环境分析
- 企业用户往往使用较旧的Python版本（出于稳定性考虑）
- 个人开发者更倾向于使用较新版本
- 不同操作系统的Python版本分布差异
- 包管理工具（pip、conda）的版本兼容性

### 技术特性需求
- 现代Python特性对代码质量的提升
- 类型提示系统的成熟度
- 异步编程特性的支持
- 性能优化特性的可用性

### 依赖库生态
- 关键依赖库的Python版本要求
- 第三方库的更新频率和兼容性
- AI相关库（如anthropic、google-generativeai）的版本要求

### 开发维护成本
- 多版本兼容性测试的复杂度
- 条件导入和功能降级的实现成本
- 长期维护和安全更新的工作量

## 考虑的方案

### 方案1: 保守策略 - 支持Python 3.7+
```yaml
支持版本: 3.7, 3.8, 3.9, 3.10, 3.11, 3.12
推荐版本: 3.9

优点:
- 最大化用户覆盖面
- 企业环境兼容性最佳
- 历史系统支持良好

缺点:
- 无法使用现代Python特性
- 开发体验受限
- 代码质量和可维护性下降
- 测试矩阵复杂
- Python 3.7已接近EOL
```

### 方案2: 激进策略 - 仅支持最新2个版本
```yaml
支持版本: 3.11, 3.12
推荐版本: 3.12

优点:
- 充分利用现代Python特性
- 开发效率最高
- 代码质量最好
- 维护成本最低

缺点:
- 用户门槛过高
- 企业用户难以采用
- 可能限制用户群体增长
```

### 方案3: 平衡策略 - Python 3.9+（选择方案）
```yaml
支持版本: 3.9, 3.10, 3.11, 3.12
推荐版本: 3.11
文档标准: 所有示例使用3.11语法

优点:
- 平衡了兼容性与现代性
- 支持大部分现代Python特性
- 覆盖主流用户环境
- 维护成本适中
- 3.9长期支持到2025年10月
```

## 决策

选择**Python 3.9+支持策略**，具体实施原则：

### 版本支持矩阵

```yaml
支持等级:
  完全支持: [3.9, 3.10, 3.11, 3.12]
  推荐版本: 3.11
  文档版本: 3.11
  开发版本: 3.11
  CI/CD测试: [3.9, 3.10, 3.11, 3.12]
  
版本策略:
  最低要求: python = "^3.9"
  推荐安装: python = "3.11.x"
  新功能开发: 基于3.11特性
  向后兼容: 确保3.9可运行
```

### 特性使用原则

#### 可使用的现代特性（Python 3.9+）
- **类型提示增强**: `list[str]`、`dict[str, int]`等内置泛型
- **字符串方法**: `str.removeprefix()`、`str.removesuffix()`
- **字典操作**: 字典合并运算符`|`和`|=`
- **装饰器支持**: 更好的装饰器类型提示
- **异步改进**: `asyncio`的性能和功能增强

#### 需要条件使用的特性（Python 3.10+）
- **模式匹配**: `match/case`语句（提供fallback实现）
- **更好的错误消息**: 利用但不依赖
- **参数规范**: `ParamSpec`等高级类型提示

#### 避免使用的特性（Python 3.11+独有）
- **异常组**: `ExceptionGroup`和`except*`
- **TOML解析**: `tomllib`（使用第三方库替代）
- **任务组**: `asyncio.TaskGroup`

### 依赖管理策略

```toml
[tool.poetry.dependencies]
python = "^3.9"

# 核心依赖 - 确保3.9+兼容
typer = "^0.9.0"  # 3.6+
rich = "^13.6.0"   # 3.7+
pydantic = "^2.4.2"  # 3.7+
click = "^8.1.7"   # 3.7+

# AI库依赖 - 通常需要较新Python
anthropic = "^0.3.11"  # 检查最低要求
google-generativeai = "^0.3.0"  # 检查最低要求

[tool.poetry.group.dev.dependencies]
# 开发工具
black = "^23.9.1"
mypy = "^1.6.0"  
pytest = "^7.4.2"

[tool.black]
target-version = ['py311']  # 格式化使用3.11标准
[tool.mypy]
python_version = "3.11"     # 类型检查使用3.11
```

### 向前兼容策略

1. **特性检测**:
```python
import sys
from typing import Union

if sys.version_info >= (3, 10):
    from types import UnionType
    StringOrInt = str | int
else:
    StringOrInt = Union[str, int]
```

2. **条件导入**:
```python
try:
    from tomllib import load as toml_load  # Python 3.11+
except ImportError:
    from toml import load as toml_load     # 第三方库
```

## 结果

这个决策带来以下影响：

### 积极影响

#### 开发体验提升
- **现代语法**: 可以使用现代Python语法提升代码可读性
- **类型安全**: 完整的类型提示支持，减少runtime错误
- **工具链**: 现代开发工具链的完整支持
- **性能优化**: 利用Python 3.9+的性能改进

#### 用户体验平衡
- **广泛兼容**: 覆盖大部分用户的Python环境
- **合理门槛**: Python 3.9已经广泛普及
- **升级路径**: 为用户提供明确的升级建议
- **长期支持**: 3.9的官方支持周期充足

#### 项目维护优化
- **测试矩阵**: 4个版本的测试矩阵相对可控
- **依赖管理**: 现代包管理工具的完整功能
- **安全更新**: 更好的安全补丁支持

### 潜在挑战与对策

#### 用户环境挑战
- **挑战**: 部分企业用户可能仍使用Python 3.8
- **对策**: 
  - 提供详细的升级指南
  - 支持多种安装方式（conda、pip、pipx）
  - 文档中说明版本要求和升级建议

#### 依赖兼容性
- **挑战**: AI相关依赖库可能要求更高版本
- **对策**:
  - 定期检查依赖库的版本要求
  - 及时调整最低版本支持
  - 提供可选依赖的降级方案

#### 新特性使用
- **挑战**: 开发者可能误用高版本特性
- **对策**:
  - 完善的CI/CD测试覆盖所有支持版本
  - 代码审查中检查版本兼容性
  - 使用工具自动检查版本兼容性

## 遵循

实施该决策需要遵循以下原则或实践：

### 版本管理原则

1. **明确声明**: 在所有相关文档中明确声明版本要求
2. **定期评估**: 每6个月评估版本支持策略的合理性
3. **渐进更新**: 新版本支持的添加和旧版本的废弃都需要渐进进行
4. **用户通知**: 版本策略变更需要提前通知用户

### 开发实践要求

1. **CI/CD覆盖**: 所有支持的Python版本都需要CI/CD测试
2. **特性检查**: 使用版本检查而非try/except进行特性适配
3. **依赖审查**: 定期审查依赖库的版本要求
4. **文档同步**: 确保文档中的示例代码与版本策略一致

### 用户支持策略

1. **安装指南**: 提供详细的Python版本安装和管理指南
2. **环境检测**: 工具启动时检测Python版本并给出建议
3. **错误提示**: 版本不兼容时提供清晰的错误信息和解决方案
4. **迁移支持**: 为用户提供Python版本升级的迁移指南

### 依赖管理规范

1. **版本锁定**: 使用合理的版本约束，避免过于严格或宽松
2. **可选依赖**: 对于高版本特性，尽量使用可选依赖
3. **降级方案**: 为高级功能提供低版本的替代实现
4. **定期更新**: 定期更新依赖库，但要确保兼容性

### 文档和交流

1. **版本标注**: 所有文档示例标注适用的Python版本
2. **推荐版本**: 在安装文档中突出推荐使用Python 3.11
3. **社区沟通**: 在社区中积极沟通版本选择的原因
4. **反馈收集**: 收集用户对版本策略的反馈和建议

---
Last Updated: 2025-01-15