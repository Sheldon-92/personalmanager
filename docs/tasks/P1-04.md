# P1-04 — 项目级 Agent 接入与命令映射（Cloud Code / Gemini COI / Claude）

> 状态: Planned  
> Owner: PO（你）负责规划与验收，Dev（Cloud）负责实现  
> Last Updated: 2025-09-14

## 1) 背景与目标

- 背景: 目前需要依赖“全局安装 pm”或手动告知 Agent 如何运行命令，不符合“项目级就地可用”的目标。希望在 Cloud Code/Gemini/Claude 中，Agent 能在项目根目录自动调用本地命令，无需全局安装与口头说明。
- 目标: 在项目根内提供统一的本地启动器及对应的 Agent 命令映射与权限配置，支持 Poetry 优先、无 Poetry 回退，并与 BMAD/BMAT 框架配置、.claude/.gemini 目录对齐。

## 2) 前置学习（必须阅读）
- `.bmad-core/core-config.yaml`、`docs/BMAD框架技术参考指南.md`（命令前缀与结构）
- `.claude/settings.local.json`（现有权限策略）
- `.gemini/commands/BMad/*`（现有命令组织）
- `pyproject.toml`, `src/pm/cli/main.py`（CLI 入口与依赖）
- `docs/tool_registration.md`（降级与错误处理模板）

## 3) 任务与验收标准（AC）

### 任务 A — 本地启动器设计与实现
- 任务: 设计 `bin/pm-local`（由 Cloud 实施），逻辑为 Poetry 优先，回退至 `PYTHONPATH=src python3 -m pm.cli.main`，不使用绝对路径。
- AC:
  1. 在项目根执行 `./bin/pm-local --version` 输出版本；`./bin/pm-local today` 返回推荐或友好提示未初始化。
  2. 在“无 Poetry/无全局安装”环境可用。
  3. 脚本为可执行文件，shell 兼容（bash/zsh）。

### 任务 B — Claude 权限与映射
- 任务: 在 `.claude/settings.local.json` 新增 `Bash(./bin/pm-local:*)`（或等效通配），避免个人绝对路径与 PYTHONPATH 硬编码。
- AC:
  1. Claude 中可直接执行 `./bin/pm-local --help/today/projects overview`。
  2. 权限白名单不包含个人绝对路径；仅项目相对路径通配。

### 任务 C — Gemini COI 命令族
- 任务: 在 `.gemini/commands/` 下新增 `pm/` 命令族，或在现有 BMad 任务内提供 `/pm` 别名任务，对接 `./bin/pm-local`。
- AC:
  1. Gemini COI 中可通过命令对话调用 `pm/today`, `pm/projects-overview`, `pm/capture`。
  2. 失败时按照 `docs/tool_registration.md` 的降级模板输出提示。

### 任务 D — 文档与入门体验
- 任务: 在 `docs/agents/local_agent_wiring.md` 记录实施方案与使用方式；更新 `docs/index.md`、`README.md` 与 `docs/user_guide.md` 的相关章节链接与示例（优先使用 `./bin/pm-local`）。
- AC:
  1. 文档示例与实际命令一致；链接可跳转。
  2. 新用户在 2-3 分钟内明白如何在项目内调用。

### 任务 E — BMAD 对齐与 ADR
- 任务: 出具 ADR（例如 ADR-0005），说明是否保留 `slashPrefix: BMad` 并通过别名实现 `/pm` 风格，或采用双前缀策略；记录权衡与影响。
- AC:
  1. ADR 包含背景/方案/决策/影响/迁移/回滚。
  2. 与现有文档术语一致，避免产生歧义。

## 4) 执行与验证步骤（Cloud）
1. 提交 A/B/C/D/E 的实现 PR，分别标注自验证记录（命令输出截图或文本）。
2. PO 验收：只信验证不信报告，对照 AC 逐项验证；PR 合并标准为“全部 AC 通过”。

## 5) 交付物清单
- 代码/配置: `bin/pm-local`；`.claude/settings.local.json` 更新；`.gemini/commands/pm/*`（或 BMad 任务别名）
- 文档: `docs/agents/local_agent_wiring.md`（实施说明）、README 和用户指南更新；ADR-0005（BMAD 对齐决策）

## 6) 风险与缓解
- 环境差异风险：在无 Poetry/不同 Shell 下兼容性问题 → 脚本降级路径清晰、CI 两套环境验证
- 权限收敛风险：通配过宽或过窄 → 仅限项目相对路径通配，评审权限变更
- 文档同步风险：命令演示与实现偏差 → PR 必须包含文档与命令输出验证

