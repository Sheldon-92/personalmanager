"""æµ‹è¯•å¹³å°ç‰‡æ®µç”Ÿæˆæ¨¡å—"""

import json
import pytest
from pm.agent.platform_snippets import (
    to_claude,
    to_gemini,
    to_gemini_script,
    validate_platform_output
)


class TestPlatformSnippets:
    """å¹³å°ç‰‡æ®µç”Ÿæˆæµ‹è¯•å¥—ä»¶"""

    def setup_method(self):
        """è®¾ç½®æµ‹è¯•ç¯å¢ƒ"""
        # åˆ›å»ºæµ‹è¯•ç”¨çš„ç¼–è¯‘åæç¤º
        self.test_doc = """# PersonalManager Expert â€” Project Instructions

## 1) è§’è‰²ä¸èŒè´£
- æ‚¨æ˜¯ PersonalManager ä¸“å®¶åŠ©æ‰‹
- ååŠ©ç”¨æˆ·ç®¡ç†ä»»åŠ¡å’Œé¡¹ç›®

## 2) å¯åŠ¨ä»ªå¼
ä¼šè¯å¼€å§‹æ—¶æŒ‰é¡ºåºæ‰§è¡Œï¼š
1. æ‰§è¡Œ `pm doctor` - ç³»ç»Ÿè¯Šæ–­
2. æ‰§è¡Œ `pm today --count 3` - ä»Šæ—¥æ¨è

## 3) è‡ªç„¶è¯­è¨€â†’å‘½ä»¤æ˜ å°„
- ç½®ä¿¡åº¦ â‰¥ 0.8: ç›´æ¥æ‰§è¡Œ
- ç½®ä¿¡åº¦ 0.5-0.8: å…ˆç¡®è®¤

## 4) é”™è¯¯å¤„ç†ä¸é™çº§
- E1xxx: é…ç½®é”™è¯¯ â†’ å¼•å¯¼è¿è¡Œ `pm setup`

## 5) éšç§ä¸å®‰å…¨
- å¤–éƒ¨è°ƒç”¨ç­–ç•¥: user_consent
- æ•°æ®ä¿ç•™: session_only"""

    def test_to_claude_basic(self):
        """æµ‹è¯• Claude å¹³å°è¾“å‡ºç”Ÿæˆ"""
        result = to_claude(self.test_doc)

        # éªŒè¯ç»“æœç±»å‹
        assert isinstance(result, str)

        # éªŒè¯åŒ…å«å¿…è¦å…ƒç´ 
        assert "PersonalManager Agent Instructions" in result
        assert "Generated by pm agent prompt compiler" in result
        assert "DO NOT EDIT MANUALLY" in result

        # éªŒè¯åŒ…å«åŸå§‹å†…å®¹
        assert "è§’è‰²ä¸èŒè´£" in result
        assert "å¯åŠ¨ä»ªå¼" in result
        assert "éšç§ä¸å®‰å…¨" in result

        # éªŒè¯åŒ…å« Claude ç‰¹å®šè¯´æ˜
        assert "Claude å¹³å°ç‰¹å®šè¯´æ˜" in result
        assert "å·¥å…·è°ƒç”¨" in result
        assert "è·¯å¾„å¤„ç†" in result

    def test_to_claude_format(self):
        """æµ‹è¯• Claude è¾“å‡ºæ ¼å¼"""
        result = to_claude(self.test_doc)

        # éªŒè¯ Markdown æ ¼å¼
        lines = result.split('\n')

        # æ£€æŸ¥æ³¨é‡Šå¤´éƒ¨
        assert lines[0].startswith("<!--")
        assert any("-->" in line for line in lines[:5])

        # æ£€æŸ¥åˆ†éš”ç¬¦
        assert "---" in result

        # æ£€æŸ¥æ ‡é¢˜æ ¼å¼
        assert any(line.startswith("#") for line in lines)

    def test_to_gemini_basic(self):
        """æµ‹è¯• Gemini å¹³å°è¾“å‡ºç”Ÿæˆ"""
        result = to_gemini(self.test_doc)

        # éªŒè¯ç»“æœç±»å‹
        assert isinstance(result, dict)

        # éªŒè¯é¡¶çº§é”®
        assert "_comment" in result
        assert "_generated_by" in result
        assert "_warning" in result
        assert "personalmanager" in result
        assert "_append_strategy" in result

        # éªŒè¯ personalmanager é…ç½®
        pm_config = result["personalmanager"]
        assert pm_config["enabled"] is True
        assert pm_config["version"] == "1.0"
        assert "system_prompt" in pm_config
        assert pm_config["system_prompt"] == self.test_doc

    def test_to_gemini_platform_specific(self):
        """æµ‹è¯• Gemini å¹³å°ç‰¹å®šé…ç½®"""
        result = to_gemini(self.test_doc)
        pm_config = result["personalmanager"]

        # éªŒè¯å¹³å°ç‰¹å®šé…ç½®
        assert "platform_specific" in pm_config
        platform = pm_config["platform_specific"]

        # æ¨¡å‹åå¥½
        assert "model_preferences" in platform
        prefs = platform["model_preferences"]
        assert "temperature" in prefs
        assert "max_tokens" in prefs
        assert 0 <= prefs["temperature"] <= 1

        # å·¥å…·é›†æˆ
        assert "tool_integration" in platform
        tools = platform["tool_integration"]
        assert tools["command_prefix"] == "pm"
        assert tools["auto_confirm"] is False

        # ä¸Šä¸‹æ–‡ç®¡ç†
        assert "context_management" in platform
        context = platform["context_management"]
        assert context["preserve_workspace"] is True

    def test_to_gemini_features(self):
        """æµ‹è¯• Gemini åŠŸèƒ½å¼€å…³"""
        result = to_gemini(self.test_doc)
        features = result["personalmanager"]["features"]

        assert features["startup_ritual"] is True
        assert features["natural_language_routing"] is True
        assert features["error_recovery"] is True
        assert features["privacy_mode"] is True

    def test_to_gemini_error_handling(self):
        """æµ‹è¯• Gemini é”™è¯¯å¤„ç†æ˜ å°„"""
        result = to_gemini(self.test_doc)
        error_handling = result["personalmanager"]["error_handling"]

        # éªŒè¯é”™è¯¯ç æ˜ å°„
        assert "E1xxx" in error_handling
        assert error_handling["E1xxx"]["action"] == "suggest_setup"
        assert error_handling["E1xxx"]["command"] == "pm setup"

        assert "E2xxx" in error_handling
        assert "E3xxx" in error_handling
        assert "E4xxx" in error_handling

    def test_to_gemini_append_strategy(self):
        """æµ‹è¯• Gemini è¿½åŠ ç­–ç•¥"""
        result = to_gemini(self.test_doc)
        strategy = result["_append_strategy"]

        assert "description" in strategy
        assert "merge_rules" in strategy
        assert isinstance(strategy["merge_rules"], list)
        assert len(strategy["merge_rules"]) > 0

        # éªŒè¯åŒ…å«åˆå¹¶ç¤ºä¾‹å‘½ä»¤
        assert "example_command" in strategy
        assert "jq" in strategy["example_command"]

    def test_to_gemini_script_basic(self):
        """æµ‹è¯• Gemini è„šæœ¬ç”Ÿæˆ"""
        result = to_gemini_script(self.test_doc)

        # éªŒè¯ç»“æœç±»å‹
        assert isinstance(result, str)

        # éªŒè¯è„šæœ¬å†…å®¹
        assert "#!/bin/bash" in result
        assert "PersonalManager Gemini é…ç½®è¿½åŠ è„šæœ¬" in result
        assert "set -e" in result

        # éªŒè¯åŒ…å«é…ç½®å†…å®¹ï¼ˆåœ¨ JSON ä¸­ï¼‰
        assert "PersonalManager Expert" in result
        assert "è§’è‰²ä¸èŒè´£" in result

        # éªŒè¯åŒ…å« jq å‘½ä»¤
        assert "jq" in result
        assert "command -v jq" in result

        # éªŒè¯å¤‡ä»½é€»è¾‘
        assert "BACKUP_FILE" in result
        assert "cp \"$GEMINI_CONFIG\" \"$BACKUP_FILE\"" in result

    def test_to_gemini_script_safety(self):
        """æµ‹è¯• Gemini è„šæœ¬å®‰å…¨æ€§"""
        result = to_gemini_script(self.test_doc)

        # éªŒè¯å®‰å…¨æªæ–½
        assert "set -e" in result  # é”™è¯¯æ—¶é€€å‡º
        assert "å¤‡ä»½ç°æœ‰é…ç½®" in result
        assert "éªŒè¯ç”Ÿæˆçš„ JSON" in result
        assert "jq empty" in result  # JSON éªŒè¯

        # éªŒè¯é”™è¯¯å¤„ç†
        assert "é…ç½®åˆå¹¶å¤±è´¥" in result
        assert "exit 1" in result

    def test_validate_platform_output_claude(self):
        """æµ‹è¯• Claude è¾“å‡ºéªŒè¯"""
        # æœ‰æ•ˆè¾“å‡º
        valid_output = to_claude(self.test_doc)
        assert validate_platform_output("claude", valid_output) is True

        # æ— æ•ˆè¾“å‡º - é”™è¯¯ç±»å‹
        assert validate_platform_output("claude", {"not": "string"}) is False

        # æ— æ•ˆè¾“å‡º - ç¼ºå°‘å¿…è¦æ ‡è®°
        invalid_output = "Some random text without required markers"
        assert validate_platform_output("claude", invalid_output) is False

    def test_validate_platform_output_gemini(self):
        """æµ‹è¯• Gemini è¾“å‡ºéªŒè¯"""
        # æœ‰æ•ˆè¾“å‡º
        valid_output = to_gemini(self.test_doc)
        assert validate_platform_output("gemini", valid_output) is True

        # æ— æ•ˆè¾“å‡º - é”™è¯¯ç±»å‹
        assert validate_platform_output("gemini", "not a dict") is False

        # æ— æ•ˆè¾“å‡º - ç¼ºå°‘å¿…è¦é”®
        invalid_output = {"some": "dict"}
        assert validate_platform_output("gemini", invalid_output) is False

        # éƒ¨åˆ†æœ‰æ•ˆè¾“å‡º
        partial_output = {
            "personalmanager": {},
            "_comment": "test"
            # ç¼ºå°‘ _append_strategy
        }
        assert validate_platform_output("gemini", partial_output) is False

    def test_validate_platform_output_unknown(self):
        """æµ‹è¯•æœªçŸ¥å¹³å°éªŒè¯"""
        assert validate_platform_output("unknown", "any") is False

    def test_to_claude_empty_doc(self):
        """æµ‹è¯•ç©ºæ–‡æ¡£å¤„ç†"""
        result = to_claude("")

        # åº”è¯¥ä»èƒ½ç”Ÿæˆæœ‰æ•ˆè¾“å‡º
        assert isinstance(result, str)
        assert "PersonalManager Agent Instructions" in result
        assert "Claude å¹³å°ç‰¹å®šè¯´æ˜" in result

    def test_to_gemini_empty_doc(self):
        """æµ‹è¯•ç©ºæ–‡æ¡£å¤„ç†"""
        result = to_gemini("")

        # åº”è¯¥ä»èƒ½ç”Ÿæˆæœ‰æ•ˆé…ç½®
        assert isinstance(result, dict)
        assert "personalmanager" in result
        assert result["personalmanager"]["system_prompt"] == ""

    def test_to_claude_unicode(self):
        """æµ‹è¯• Unicode å­—ç¬¦å¤„ç†"""
        unicode_doc = "æµ‹è¯•ä¸­æ–‡å†…å®¹ ğŸš€ Ã©mojis å’Œç‰¹æ®Šå­—ç¬¦ Ã±"
        result = to_claude(unicode_doc)

        assert unicode_doc in result
        assert "ğŸš€" in result
        assert "ä¸­æ–‡" in result

    def test_to_gemini_unicode(self):
        """æµ‹è¯• Gemini Unicode å¤„ç†"""
        unicode_doc = "æµ‹è¯•ä¸­æ–‡å†…å®¹ ğŸš€ Ã©mojis"
        result = to_gemini(unicode_doc)

        # JSON åº”æ­£ç¡®å¤„ç† Unicode
        json_str = json.dumps(result, ensure_ascii=False)
        assert "ä¸­æ–‡" in json_str
        assert "ğŸš€" in json_str

    def test_to_gemini_script_escaping(self):
        """æµ‹è¯•è„šæœ¬ä¸­çš„ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰"""
        doc_with_quotes = 'Test with "quotes" and \'apostrophes\''
        result = to_gemini_script(doc_with_quotes)

        # éªŒè¯æ­£ç¡®è½¬ä¹‰
        assert result  # ä¸åº”è¯¥å› ä¸ºå¼•å·è€Œå¤±è´¥

        # éªŒè¯ HEREDOC ä½¿ç”¨
        assert "<<'END_SNIPPET'" in result


if __name__ == "__main__":
    pytest.main([__file__, "-v"])